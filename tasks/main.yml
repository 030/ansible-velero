---
- name: version
  shell: velero version --client-only | grep Version | sed -e "s|^.*v\(.*\)$|\1|"
  register: velero_installed_version

  debug:
    msg: velero_installed_version

- name: download
  get_url:
    url: "{{ velero_url }}"
    dest: /tmp
    checksum: "{{ velero_checksum }}"
  when: velero_installed_version == velero_version

- block:
    - name: unarchive
      unarchive:
        src: "/tmp/{{ velero_pkg_ext }}"
        dest: /tmp
        remote_src: true
        creates: "{{ velero_bin }}"

    - name: executable bin for every user
      copy:
        src: "/tmp/{{ velero_pkg_bin }}"
        dest: "{{ velero_bin }}"
        remote_src: true
        owner: root
        group: root
        mode: '0755'
  become: true
  when: velero_installed_version == velero_version
